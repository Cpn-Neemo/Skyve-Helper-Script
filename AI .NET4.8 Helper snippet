#!/usr/bin/env bash
set -euo pipefail          # abort on errors / undefined vars

# -------------------------------------------------
# 0️⃣  Simple logger (adds a HH:MM:SS timestamp)
# -------------------------------------------------
log() {
    printf '[%s] %s\n' "$(date '+%H:%M:%S')" "$*"
}

# -------------------------------------------------
# 1️⃣  Paths (STEAM_ID is defined earlier in the script)
# -------------------------------------------------
GAC_DIR="$STEAM_ID/drive_c/windows/Microsoft.NET/assembly/GAC_MSIL"
DLL_FILE="$GAC_DIR/Microsoft.Windows.Compatibility.dll"

# -------------------------------------------------
# 2️⃣  Helper: check whether .NET 4.8 is present
# -------------------------------------------------
net48_installed() {
    [[ -d "$GAC_DIR" ]] && \
    [[ -f "$DLL_FILE" ]] && \
    grep -a -q "v4\.8" "$DLL_FILE"
}

# -------------------------------------------------
# 3️⃣  Main flow
# -------------------------------------------------
if net48_installed; then
    log ".NET 4.8 is already installed – continuing."
else
    log "Now installing .NET 4.8 dependency…"
    protontricks "$STEAM_ID" -q dotnet48 &
    dotnet_pid=$!
    wait "$dotnet_pid"

    # Verify the install succeeded
    if net48_installed; then
        log ".NET 4.8 installed successfully – continuing."
    else
        log "ERROR: .NET 4.8 installation failed – quitting."
        exit 1
    fi
fi

# -------------------------------------------------
# 4️⃣  Continue with the rest of your script below …
# -------------------------------------------------